# ============================================================================
# Configuration Mosquitto MQTT Broker
# ============================================================================
# Version: 2.0
# Description: Configuration pour le système de contrôle d'accès IoT
# ============================================================================

# ============================================================================
# GENERAL SETTINGS
# ============================================================================

# User pour exécuter le broker (auto avec Docker)
# user mosquitto

# ============================================================================
# PERSISTENCE
# ============================================================================

# Activer la persistence des messages et subscriptions
persistence true

# Dossier de persistence
persistence_location /mosquitto/data/

# Fichier de persistence
autosave_interval 300
autosave_on_changes false

# ============================================================================
# LOGGING
# ============================================================================

# Destinations des logs
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout

# Types de logs (all, error, warning, notice, information, subscribe, unsubscribe, websockets, none)
log_type error
log_type warning
log_type notice
log_type information

# Format timestamp
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# ============================================================================
# SECURITY - AUTHENTICATION
# ============================================================================

# ATTENTION: En DEV, on autorise les connexions anonymes
# EN PRODUCTION: Configurer un fichier de passwords avec mosquitto_passwd
allow_anonymous true

# Pour production, décommenter et créer le fichier password:
# allow_anonymous false
# password_file /mosquitto/config/passwd

# Pour créer le fichier password en production:
# docker exec -it mqtt-broker mosquitto_passwd -c /mosquitto/config/passwd username

# ============================================================================
# LISTENER 1 - MQTT Standard (Port 1883)
# ============================================================================

listener 1883
protocol mqtt

# Nombre max de connexions (-1 = illimité)
max_connections -1

# ============================================================================
# LISTENER 2 - WebSocket (Port 9001)
# ============================================================================

listener 9001
protocol websockets

# Pour production avec TLS, décommenter:
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# cafile /mosquitto/certs/ca.crt

# ============================================================================
# MESSAGE SETTINGS
# ============================================================================

# Taille maximale d'un message (0 = pas de limite)
max_packet_size 1000

# Nombre max de messages QoS 1 et 2 en attente
max_queued_messages 1000

# Nombre max de messages QoS > 0 en vol
max_inflight_messages 100

# QoS maximum supporté (0, 1, ou 2)
max_qos 2

# ============================================================================
# RETAINED MESSAGES
# ============================================================================


# Persist les retained messages
retained_persistence true

# ============================================================================
# TOPICS & ACL
# ============================================================================

# Topics système accessibles
# allow_zero_length_clientid true

# Pour production, définir des ACL (Access Control List):
# acl_file /mosquitto/config/acl

# Exemple de fichier ACL (créer /mosquitto/config/acl):
# # User admin - accès complet
# user admin
# topic readwrite #
#
# # User backend - lecture badges, écriture commandes
# user backend
# topic read iot/entrance/+/badge/scan
# topic write iot/entrance/+/lock/command
# topic write iot/entrance/+/lock/status
#
# # User sensor - écriture télémétrie uniquement
# user sensor
# topic write iot/sensor/+/telemetry

# ============================================================================
# PERFORMANCE
# ============================================================================

# Délai de keepalive (secondes)
# Le client doit envoyer un PINGREQ avant ce délai
# max_keepalive 65535

# Nombre de threads pour les listeners
# listener_worker_threads 4

# ============================================================================
# WEBSOCKET SETTINGS
# ============================================================================

# HTTP headers pour WebSocket
# websockets_log_level 255

# ============================================================================
# BRIDGE (pour connecter plusieurs brokers - optionnel)
# ============================================================================

# Exemple pour connecter à un broker cloud:
# connection bridge-to-cloud
# address mqtt.cloud-provider.com:8883
# topic iot/# out 2
# bridge_attempt_unsubscribe true
# bridge_protocol_version mqttv311
# cleansession true

# ============================================================================
# WILL MESSAGES
# ============================================================================

# Autoriser les clients à définir un "Last Will and Testament"
# max_keepalive 60

# ============================================================================
# FIN DE LA CONFIGURATION
# ============================================================================

# Topics par défaut pour le système:
# iot/entrance/{zone_id}/badge/scan      - Scans de badges (sensors ? backend)
# iot/entrance/{zone_id}/lock/command    - Commandes vers serrures (backend ? locks)
# iot/entrance/{zone_id}/lock/status     - Status des serrures (locks ? backend)
# iot/sensor/{sensor_id}/telemetry       - Télémétrie générale (sensors ? backend)